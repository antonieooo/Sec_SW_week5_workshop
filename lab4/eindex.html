<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet"
        href="https://unpkg.com/@geoapify/leaflet-address-search-plugin@^1/dist/L.Control.GeoapifyAddressSearch.min.css" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body onload="initPage()">
    <h3>E-Manager</h3>

    <div class="main">
        <span style="display:flex; justify-content:flex-end; width:100%; padding: 3px;">
            <span id="name_label" style="justify-content: left; width:100%;"></span><button onclick="refresh()"
                class="buttonToLink">refresh</button>
        </span>

        <label for="host name">Host Name:</label>
        <input type="text" id="hostname" name="hostname" placeholder="Enter event host" required>
        <br>
        <label for="email">Host Email:</label>
        <input type="email" id="email" name="email" placeholder="Enter Host Email" required>
        <br>
        <label for="event name">Event Name:</label>
        <input type="text" id="eventname" name="eventname" placeholder="Enter event Name" required>
        <br>
        <label for="event date">Date:</label>
        <input type="datetime-local" id="eventdate" name=eventdate value="2023-06-12T19:30"/>
        <br>
        <label for="description">Description:</label>
        <input type="text" id="eventdesc" name="eventdesc" placeholder="Enter short description of event" required>
        <br>
        <label for="event location">Location:</label>
        <div id="map"></div>
        <br>
        <span style="display:flex; justify-content:flex-end; width:100%; padding:0;">
            <input type="button" onclick="addEvent()" value="add" />
        </span>
        
    </div>

    <div class="row" id="eventsrow" style="align-items: center;">

    </div>
</body>

<script>
    calendarEvents = []
    const api_address = `${document.baseURI}`
    let eventsStream = null

    function initPage() {
        refresh()
        connectEventStream()
    }

    function addEvent() {
        let eventname = document.getElementById("eventname").value
        let hostname = document.getElementById("hostname").value
        let contactemail = document.getElementById("email").value
        let eventdescription = document.getElementById("eventdesc").value
        // let eventlocation = {"lat":ws_address.lat, "lon":ws_address.lon, "city":ws_address.city, "country":ws_address.country}
        let eventlocation = ws_address
        let eventdate = document.getElementById("eventdate").value

        if (!eventlocation) {
            alert("Please select a location on the map first.")
            return
        }

        let eevent = {
            "EventName": eventname,
            "HostName": hostname,
            "ContactEmail": contactemail,
            "description": eventdescription,
            "location": eventlocation,
            "date": eventdate
        }

        fetch(`${api_address}events`, {
            method: "POST",
            body: JSON.stringify(eevent),
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            }
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error("Add event failed")
                }
                return response.json()
            })
            .then((json) => {
                console.log(json)

                document.getElementById("eventname").value = ''
                document.getElementById("hostname").value = ''
                document.getElementById("email").value = ''
                document.getElementById("eventdesc").value = ''
                document.getElementById("eventdate").value = ''
                refresh()
            })
            .catch((error) => {
                console.log(error)
            });

    }

    function deleteEvent(eventid){
        fetch(`${api_address}events`, {
            method: "DELETE",
            body: JSON.stringify({eventid:eventid}),
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            }
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error("Delete event failed")
                }
                return response.json()
            })
            .then((json) => {
                console.log(json)
                refresh()
            })
            .catch((error) => {
                console.log(error)
            });

    }

    function refresh() {
        fetch(`${api_address}events`, {
            method: "GET",
            headers: {
                "content-type": "application/json; charset=UTF-8"
            }
        })
            .then(response => {
                if (response.ok) {
                    // Parse the response data as JSON
                    return response.json();
                } else {
                    throw new Error('API request failed');
                }
            })
            .then(data => {
                calendarEvents = data
                // const rows = document.getElementById("eventsrow");
                // rows.innerHTML = ''
                var el = document.getElementById('eventsrow');
                while ( el.firstChild ) el.removeChild( el.firstChild );

                for (let i = 0; i < calendarEvents.length; i++) {
                    const cevent = calendarEvents[i]

                    let status = 'active'
                    var now = new Date();
                    if (new Date(cevent.date) < now) {
                        status = 'expired'
                    }
                    const city = cevent.location?.city || 'Unknown city'
                    const country = cevent.location?.country || 'Unknown country'

                    var column = document.createElement('div');
                    column.className = 'column';

                    var card = document.createElement('div');
                    card.className = 'card';

                    let sdiv = `<span style="display:flex; justify-content:flex-end; width:100%; padding: 3px;">
                                <span style="justify-content: left; width:100%; font-size:0.7em;">${cevent.HostName} (${cevent.ContactEmail})</span>    
                                <button onclick="deleteEvent('${cevent.eventid}')" class="buttonToLink">delete</button>
                                </span>
                                <span style="justify-content: left; width:100%;"><label style="justify-content: left; font-size:0.7em; padding: 3px;"><b>${cevent.EventName}</b></label></span>    
                                <p class="innercard">${cevent.description}</p>
                                
                                <span style="display:flex; justify-content:flex-end; width:100%; padding: 3px;  margin: 10px auto; font-size:0.8em;">
                                ${city}, ${country}. ${cevent.date}
                                </span>
                                <span style="display:flex; justify-content:flex-end; width:100%; padding: 3px;  margin: 10px auto; font-size:0.8em;">
                                ${status}
                                </span>`
                    card.innerHTML = sdiv
                    column.appendChild(card)
                    el.appendChild(column)
                }

                window.scrollTo(0, document.body.scrollHeight);

            })
            .catch(error => {
                console.log(error)
            })

    }

    function connectEventStream() {
        if (eventsStream) {
            return
        }

        eventsStream = new EventSource(`${api_address}events/stream`)

        eventsStream.addEventListener('connected', (event) => {
            console.log('SSE connected', event.data)
        })

        eventsStream.addEventListener('events-updated', (event) => {
            console.log('Events updated', event.data)
            refresh()
        })

        eventsStream.onerror = (error) => {
            console.log('SSE error', error)
        }
    }
</script>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@geoapify/leaflet-address-search-plugin@^1/dist/L.Control.GeoapifyAddressSearch.min.js"></script>
<script src="/js/eeventlocation.js"></script>


</html>
